# Introduction ------------------------------------------------------------
# This builds / modifies a spreadsheet for manually recording pollen count 
# data for each well. Approximate counts are done using montages generated 
# during image sequence processing. To not overwrite data, the script first 
# downloads the current version of the sheet, then combines any new rows 
# with existing rows while preserving any pollen count data that has already 
# been entered. This script should be run nightly, after the 
# process_worksheets.R script. Any information about new wells will come 
# from the sheet generated by process_worksheets.R.
 
library(googlesheets4)
library(dplyr)

# Adding my Google service account credentials
gs4_auth(path = "~/.credentials/google_sheets_api/service_account.json")


# Reading in the existing sheets ------------------------------------------
# Sheet generated by process_worksheets.R
plate_worksheets_id = "1yQ5yAKiL6BzwZ-wH-Q44RoUEwMZztTYafzdvVylq6fo"
plate_worksheets <- read_sheet(plate_worksheets_id)

# Current version of pollen count sheet
pollen_count_sheet_id <- "10_lG9N0wGvgOmxDGuX5PXILB7QwC7m6CuYXzi78Qe3Q"
pollen_count_sheet <- read_sheet(pollen_count_sheet_id, sheet = "Sheet1")


# Building new sheet and comparing to old sheet ---------------------------
# First, making a new sheet with all the possible wells.
new_sheet <- plate_worksheets[ , c("date", "run", "well")]

# This should preserve existing data
updated_sheet <- left_join(new_sheet, pollen_count_sheet)


# Uploading the updated sheet ---------------------------------------------
# Finally, uploading the sheet with new rows and existing old rows.
write_sheet(data = updated_sheet, 
            ss = pollen_count_sheet_id,
            sheet = "Sheet1")
